class CultivationPlan{constructor(){this.canvas=document.querySelector("#CultivationPlan"),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.act_color={},this.status_color={},this.status_opacity=.5,this.articles=[],this.set_font("14px 'MS P Gothic'"),this.padding=10,this.border_width=.25,this.border_color="gray",this.month_bgcolor=null,this.is_legend=!0,this.today_width=.5,this.today_color=null}add_action(t,i){this.act_color[t]=i}add_status(t,i){this.status_color[t]=i}set_status_opacity(t){this.status_opacity=t}set_font(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1]),this.ystep=2*this.font_size}set_padding(t){this.padding=t}set_border(t,i){this.border_width=t,this.border_color=i}set_month_bgcolor(t){this.month_bgcolor=t}hide_legend(){this.is_legend=!1}set_today(t,i){this.today_width=t,this.today_color=i}draw(t){this.label_width=this.get_max_name_width_(t)+10,this.xzero=this.padding+this.label_width+1,this.xstep=(this.canvas_width-this.label_width-2*this.padding)/36,this.draw_month_(t.length);let i=this.padding+this.ystep;for(let s=0;s<t.length;s++){let e=t[s],h=[];for(let l in e)switch(l){case"name":case"color":case"status":break;default:void 0!==this.act_color[l]&&h.push(l)}let d=[],a=Array(36).fill(0),o=!1;for(let r=0;r<h.length;r++){let n=h[r],{start:c,end:p}=this.get_period_(e[n]),g=0;if(c<p){for(let x=c;x<p;x++)if(0!=a[x]){g=1;break}if(0==g)for(let w=c;w<p;w++)a[w]=r+1;else o=!0}else{for(let f=c;f<36;f++)if(0!=a[f]){g=1;break}if(0==g){for(let _=0;_<p;_++)if(0!=a[_]){g=1;break}}if(0==g){for(let u=c;u<36;u++)a[u]=r+1;for(let b=0;b<p;b++)a[b]=r+1}else o=!0}d.push({key:n,start:c,end:p,ypos:i,y2nd:g})}let $=this.ystep;o&&($+=this.ystep/2),this.draw_name_(i,$,e.color,"black",e.name);for(let y=1;y<=12;y++){let v=this.xzero+(y-1)*3*this.xstep;this.draw_line_(v,i,v,i+$,this.border_color,this.border_width)}let m=this.xzero+36*this.xstep;this.draw_line_(m-1,i,m-1,i+$,this.border_color,this.border_width);let z=0;for(let k=0;k<d.length;k++){let{key:S,start:T,end:R,ypos:P,y2nd:C}=d[k];o&&(z=0==C?-1:1),this.draw_period_(P,z,this.act_color[S],T,R)}void 0!==this.status_color[e.status]&&this.draw_status_(i,$,this.status_color[e.status],this.status_opacity),this.draw_line_(this.padding,i,this.canvas_width-this.padding,i,this.border_color,this.border_width),i+=$}this.draw_line_(this.padding,i,this.canvas_width-this.padding,i,this.border_color,this.border_width);let L=this.padding+this.ystep;null!=this.today_color&&this.draw_today_(L,i-L,this.today_color,this.today_width),this.is_legend&&this.draw_legend_(i)}add_log(t,i,s,e){let h=`<div class="name">${t}</div>`,l=s.split(", "),d=this.articles.find(i=>i.name==t),a=`<div class="date">${i}</div>`;for(let o=0;o<l.length;o++)a+=`<img src="${l[o]}">`;if(a+='<p class="popup-text">'+e+'</p><div class="clear"></div>',void 0==d){let r=h+a;this.articles.push({name:t,content:r})}else d.content+=a}get_logs(){let t="",i="";for(let s=0;s<this.articles.length;s++){let e=this.articles[s],h="popup"+s;t+=this.get_popup_link_(h,e.name),i+=this.get_popup_content_(h,e.content)}return'<p class="indent">'+t+i+"</p>"}get_popup_link_(t,i){let s='<div class="CultivationLogLabel">';return s+=`<a href="" class="popup-open" data-modal-btn=${t}>${i}</a>`,s+="</div>"}get_popup_content_(t,i){let s=`<div class="popup-wrap" data-modal-cont=${t}>`;return s+='<div class="popup-back"></div>',s+='<div class="popup-inner"><span class="popup-close"></span><div class="popup-contents">',s+=i,s+="</div></div></div>"}get_max_name_width_(t){let i=0;for(let s=0;s<t.length;s++){let e=this.ctx.measureText(t[s].name).width;e>i&&(i=e)}return i}draw_month_(t){null!=this.month_bgcolor&&(this.ctx.fillStyle=this.month_bgcolor,this.xzero,this.ctx.fillRect(this.xzero+1,this.padding+1,36*this.xstep-2,this.ystep-1)),this.ctx.fillStyle="black",this.draw_line_(this.padding,this.padding,this.canvas_width-this.padding,this.padding,this.border_color,this.border_width),this.draw_line_(this.padding,this.padding,this.padding,this.padding+this.ystep,this.border_color,this.border_width);for(let i=1;i<=12;i++){let s=this.xzero+(i-1)*3*this.xstep;this.draw_line_(s,this.padding,s,this.padding+this.ystep,this.border_color,this.border_width);let e=String(i),h=this.ctx.measureText(e),l=(3*this.xstep-h.width)/2,d=this.padding+this.ystep/2+this.font_size/2;this.ctx.fillText(e,s+l,d)}let a=this.xzero+36*this.xstep;this.draw_line_(a-1,this.padding,a-1,this.padding+this.ystep,this.border_color,this.border_width)}draw_name_(t,i,s,e,h){null!=s&&void 0!==s&&(this.ctx.fillStyle=s,this.ctx.fillRect(this.padding,t+1,this.label_width,i-1)),this.draw_line_(this.padding,t,this.padding,t+i,this.border_color,this.border_width);let l=this.ctx.measureText(h),d=this.padding+(this.label_width-l.width)/2,a=i/2+this.font_size/2;this.ctx.fillStyle=e,this.ctx.fillText(h,d,t+a)}get_period_(t){let i={a:0,b:1,c:2},s=t.split("-"),e=i[s[0].slice(-1)],h=void 0===e?(+s[0]-1)*3:(+s[0].slice(0,-1)-1)*3+e,l=i[s[1].slice(-1)],d=void 0===l?3*+s[1]:(+s[1].slice(0,-1)-1)*3+l+1;return{start:h,end:d}}draw_period_(t,i,s,e,h){if(void 0===s)return;this.ctx.fillStyle=s;let l=t+this.ystep/4;1==i&&(l+=this.ystep/2);let d=this.ystep/2,a=e*this.xstep,o=h*this.xstep;if(e<h)this.ctx.fillRect(this.xzero+a+1,l,o-a-2,d);else{let r=36*this.xstep;this.ctx.fillRect(this.xzero+a+1,l,r-a-2,d),this.ctx.fillRect(this.xzero+1,l,o-2,d)}}draw_status_(t,i,s,e){this.ctx.globalAlpha=e,this.ctx.fillStyle=s,this.ctx.fillRect(this.padding+1,t+1,this.label_width+36*this.xstep-2,i-1),this.ctx.globalAlpha=1}draw_legend_(t){let i=3*this.ystep/5,s=2*this.padding;t+=this.padding+2;let e=100;for(let h in this.act_color){this.ctx.fillStyle=this.act_color[h],this.ctx.fillRect(s,t+1,30,i+1),this.ctx.fillStyle="black";let l=this.ctx.measureText(h);l.width>e&&(e=l.width);let d=30+this.padding/2;s+=d;let a=i/2+this.font_size/2;this.ctx.fillText(h,s,t+a),(s+=l.width+this.padding+2)>this.canvas_width-(e+d+this.padding+2)&&(s=2*this.padding,t+=i+this.padding)}if(null!=this.today_color){s+=this.padding/2,this.draw_line_(s,t,s,t+i,this.today_color,this.today_width),s+=this.padding/2;let o=i/2+this.font_size/2;this.ctx.fillText("今日",s,t+o)}}draw_today_(t,i,s,e){let h=new Date,l=h.getMonth(),d=h.getDate(),a=this.xzero+(3*l+d/10)*this.xstep;this.ctx.setLineDash([10,10]),this.draw_line_(a,t,a,t+i,s,e),this.ctx.setLineDash([])}draw_line_(t,i,s,e,h,l){this.ctx.lineWidth=l,this.ctx.strokeStyle=h,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(s,e),this.ctx.closePath(),this.ctx.stroke()}}