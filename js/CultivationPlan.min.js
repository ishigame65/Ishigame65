class CultivationPlan{constructor(){this.canvas=document.querySelector("#CultivationPlan"),this.canvas_width=this.canvas.clientWidth,this.canvas_height=this.canvas.clientHeight,this.ctx=this.canvas.getContext("2d"),this.act_color={},this.status_color={},this.status_opacity=.5,this.set_font("14px 'MS P Gothic'"),this.padding=10,this.border_width=.25,this.border_color="gray",this.month_bgcolor=null,this.is_legend=!0,this.today_width=.5,this.today_color=null}add_action(t,i){this.act_color[t]=i}add_status(t,i){this.status_color[t]=i}set_status_opacity(t){this.status_opacity=t}set_font(t){this.ctx.font=t,this.font_size=parseInt(t.match(/(\d+)px/)[1]),this.ystep=2*this.font_size}set_padding(t){this.padding=t}set_border(t,i){this.border_width=t,this.border_color=i}set_month_bgcolor(t){this.month_bgcolor=t}hide_legend(){this.is_legend=!1}set_today(t,i){this.today_width=t,this.today_color=i}draw(t){this.label_width=this.get_max_name_width_(t)+10,this.xzero=this.padding+this.label_width+1,this.xstep=(this.canvas_width-this.label_width-2*this.padding)/36,this.draw_month_(t.length);let i=this.padding+this.ystep;for(let s=0;s<t.length;s++){let h=t[s],e=[];for(let l in h)switch(l){case"name":case"color":case"status":break;default:void 0!==this.act_color[l]&&e.push(l)}let d=[],o=Array(36).fill(0),a=!1;for(let r=0;r<e.length;r++){let n=e[r],{start:c,end:p}=this.get_period_(h[n]),x=0;if(c<p){for(let g=c;g<p;g++)if(0!=o[g]){x=1;break}if(0==x)for(let w=c;w<p;w++)o[w]=r+1;else a=!0}else{for(let _=c;_<36;_++)if(0!=o[_]){x=1;break}if(0==x){for(let f=0;f<p;f++)if(0!=o[f]){x=1;break}}if(0==x){for(let b=c;b<36;b++)o[b]=r+1;for(let $=0;$<p;$++)o[$]=r+1}else a=!0}d.push({key:n,start:c,end:p,ypos:i,y2nd:x})}let y=this.ystep;a&&(y+=this.ystep/2),this.draw_name_(i,y,h.color,"black",h.name);for(let u=1;u<=12;u++){let m=this.xzero+(u-1)*3*this.xstep;this.draw_line_(m,i,m,i+y,this.border_color,this.border_width)}let v=this.xzero+36*this.xstep;this.draw_line_(v-1,i,v-1,i+y,this.border_color,this.border_width);let z=0;for(let S=0;S<d.length;S++){let{key:T,start:k,end:R,ypos:P,y2nd:C}=d[S];a&&(z=0==C?-1:1),this.draw_period_(P,z,this.act_color[T],k,R)}void 0!==this.status_color[h.status]&&this.draw_status_(i,y,this.status_color[h.status],this.status_opacity),this.draw_line_(this.padding,i,this.canvas_width-this.padding,i,this.border_color,this.border_width),i+=y}this.draw_line_(this.padding,i,this.canvas_width-this.padding,i,this.border_color,this.border_width);let D=this.padding+this.ystep;null!=this.today_color&&this.draw_today_(D,i-D,this.today_color,this.today_width),this.is_legend&&this.draw_legend_(i)}get_max_name_width_(t){let i=0;for(let s=0;s<t.length;s++){let h=this.ctx.measureText(t[s].name).width;h>i&&(i=h)}return i}draw_month_(t){null!=this.month_bgcolor&&(this.ctx.fillStyle=this.month_bgcolor,this.xzero,this.ctx.fillRect(this.xzero+1,this.padding+1,36*this.xstep-2,this.ystep-1)),this.ctx.fillStyle="black",this.draw_line_(this.padding,this.padding,this.canvas_width-this.padding,this.padding,this.border_color,this.border_width),this.draw_line_(this.padding,this.padding,this.padding,this.padding+this.ystep,this.border_color,this.border_width);for(let i=1;i<=12;i++){let s=this.xzero+(i-1)*3*this.xstep;this.draw_line_(s,this.padding,s,this.padding+this.ystep,this.border_color,this.border_width);let h=String(i),e=this.ctx.measureText(h),l=(3*this.xstep-e.width)/2,d=this.padding+this.ystep/2+this.font_size/2;this.ctx.fillText(h,s+l,d)}let o=this.xzero+36*this.xstep;this.draw_line_(o-1,this.padding,o-1,this.padding+this.ystep,this.border_color,this.border_width)}draw_name_(t,i,s,h,e){null!=s&&void 0!==s&&(this.ctx.fillStyle=s,this.ctx.fillRect(this.padding,t+1,this.label_width,i-1)),this.draw_line_(this.padding,t,this.padding,t+i,this.border_color,this.border_width);let l=this.ctx.measureText(e),d=this.padding+(this.label_width-l.width)/2,o=i/2+this.font_size/2;this.ctx.fillStyle=h,this.ctx.fillText(e,d,t+o)}get_period_(t){let i={a:0,b:1,c:2},s=t.split("-"),h=i[s[0].slice(-1)],e=void 0===h?(+s[0]-1)*3:(+s[0].slice(0,-1)-1)*3+h,l=i[s[1].slice(-1)],d=void 0===l?3*+s[1]:(+s[1].slice(0,-1)-1)*3+l+1;return{start:e,end:d}}draw_period_(t,i,s,h,e){if(void 0===s)return;this.ctx.fillStyle=s;let l=t+this.ystep/4;1==i&&(l+=this.ystep/2);let d=this.ystep/2,o=h*this.xstep,a=e*this.xstep;if(h<e)this.ctx.fillRect(this.xzero+o+1,l,a-o-2,d);else{let r=36*this.xstep;this.ctx.fillRect(this.xzero+o+1,l,r-o-2,d),this.ctx.fillRect(this.xzero+1,l,a-2,d)}}draw_status_(t,i,s,h){this.ctx.globalAlpha=h,this.ctx.fillStyle=s,this.ctx.fillRect(this.padding+1,t+1,this.label_width+36*this.xstep-2,i-1),this.ctx.globalAlpha=1}draw_legend_(t){let i=3*this.ystep/5,s=2*this.padding;t+=this.padding+2;let h=100;for(let e in this.act_color){this.ctx.fillStyle=this.act_color[e],this.ctx.fillRect(s,t+1,30,i+1),this.ctx.fillStyle="black";let l=this.ctx.measureText(e);l.width>h&&(h=l.width);let d=30+this.padding/2;s+=d;let o=i/2+this.font_size/2;this.ctx.fillText(e,s,t+o),(s+=l.width+this.padding+2)>this.canvas_width-(h+d+this.padding+2)&&(s=2*this.padding,t+=i+this.padding)}if(null!=this.today_color){s+=this.padding/2,this.draw_line_(s,t,s,t+i,this.today_color,this.today_width),s+=this.padding/2;let a=i/2+this.font_size/2;this.ctx.fillText("今日",s,t+a)}}draw_today_(t,i,s,h){let e=new Date,l=e.getMonth(),d=e.getDate(),o=this.xzero+(3*l+d/10)*this.xstep;this.ctx.setLineDash([10,10]),this.draw_line_(o,t,o,t+i,s,h),this.ctx.setLineDash([])}draw_line_(t,i,s,h,e,l){this.ctx.lineWidth=l,this.ctx.strokeStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(s,h),this.ctx.closePath(),this.ctx.stroke()}}